name: Daily Emotion Analysis

on:
  schedule:
    # Îß§Ïùº 12Ïãú (UTC Í∏∞Ï§Ä 3Ïãú = ÌïúÍµ≠ÏãúÍ∞Ñ 12Ïãú)
    - cron: '0 3 * * *'
  workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  daily-emotion-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install server dependencies
        run: |
          cd server
          npm install

      - name: Build TypeScript
        run: |
          cd server
          npx tsc
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Generate Prisma client
        run: |
          cd server
          npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run daily emotion analysis
        run: |
          cd server
          node -e "
          const { scheduleDailyEmotionSummary } = require('./dist/lib/scheduler.js');
          (async () => {
            try {
              console.log('üïê Starting daily emotion analysis...');
              await scheduleDailyEmotionSummary();
              console.log('‚úÖ Daily emotion analysis completed successfully');
            } catch (error) {
              console.error('‚ùå Daily emotion analysis failed:', error);
              throw error;
            }
          })();
          "
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REFRESH_TOKEN_SECRET: ${{ secrets.REFRESH_TOKEN_SECRET }}
